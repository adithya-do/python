import subprocess
import os

CONFIG_FILE = '/opt/oracle/scripts/ogg_mon/ogg.conf'
SENDMAIL_PATH = '/usr/sbin/sendmail'

def read_config():
    entries = []
    with open(CONFIG_FILE, 'r') as f:
        for line in f:
            line = line.strip()
            if not line or line.startswith('#'):
                continue
            parts = line.split('|')
            if len(parts) == 3:
                gg_home, db_name, email = parts
                entries.append({'gg_home': gg_home, 'db_name': db_name, 'email': email})
    return entries

def run_ggsci_command(gg_home, command):
    ggsci = os.path.join(gg_home, 'ggsci')
    try:
        output = subprocess.check_output(
            f'echo "{command}" | {ggsci}', 
            shell=True, stderr=subprocess.STDOUT, text=True
        )
        return output
    except subprocess.CalledProcessError as e:
        return f"Error executing GGSCI: {e.output}"

def parse_status(output):
    alerts = []
    for line in output.splitlines():
        if line.strip().startswith(('EXTRACT', 'REPLICAT')):
            if any(bad in line.upper() for bad in ['STOP', 'ABEND', 'LAG']):
                alerts.append(line)
    return alerts

def send_email(subject, html_body, to_email):
    from_email = "ogg-monitor@example.com"
    message = f"""From: {from_email}
To: {to_email}
Subject: {subject}
MIME-Version: 1.0
Content-Type: text/html

{html_body}
"""
    process = subprocess.Popen([SENDMAIL_PATH, "-t", "-oi"], stdin=subprocess.PIPE)
    process.communicate(message.encode())

def generate_html_report(db_name, manager_status, alerts):
    style = """
    <style>
    body { font-family: Arial; }
    table { border-collapse: collapse; width: 100%%; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #f2f2f2; }
    </style>
    """
    html = f"<html><head>{style}</head><body>"
    html += f"<h2>GoldenGate Alert Report - {db_name}</h2>"
    html += "<h3>Manager Status</h3><pre>{}</pre>".format(manager_status.strip())
    if alerts:
        html += "<h3>Alert: Processes Not Running or Lagging</h3><table><tr><th>Process Info</th></tr>"
        for alert in alerts:
            html += f"<tr><td>{alert}</td></tr>"
        html += "</table>"
    else:
        html += "<p>All processes are running normally.</p>"
    html += "</body></html>"
    return html

def monitor():
    configs = read_config()
    for entry in configs:
        gg_home = entry['gg_home']
        db_name = entry['db_name']
        email = entry['email']

        info_output = run_ggsci_command(gg_home, 'info all')
        mgr_output = run_ggsci_command(gg_home, 'info manager')

        alerts = parse_status(info_output)
        if alerts:
            html = generate_html_report(db_name, mgr_output, alerts)
            subject = f"[ALERT] GoldenGate issue on {db_name}"
            send_email(subject, html, email)

if __name__ == '__main__':
    monitor()
